<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>My Courses</title>
    <meta name="robots" content="noindex, follow"/>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png">

    <!-- CSS
	============================================ -->
    <link rel="stylesheet" th:href="@{/assets/css/vendor/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/slick.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/slick-theme.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/sal.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/feather.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/fontawesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/euclid-circulara.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/swiper.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/magnify.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/odometer.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/animation.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/bootstrap-select.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/jquery-ui.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/magnigy-popup.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/plugins/plyr.css}">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <!--jquery-->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!-- ●●js  for jquery datatables 用 -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <!-- ●●js  for jquery datatables 用 -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.jqueryui.min.css"/>

    <style>
        #card_image {
            height: 122px;
            width: 178px;
            object-fit: cover;
        }

        #headshot {
            min-height: 120px;
        }

        .bg_image--23 {
            background-image: url("../images/bg/bbyoda.jpg");
        }
    </style>
</head>

<body>

<!-- Start Header Area -->
<div th:replace="/front-end/header.html"></div>
<!-- Mobile Menu Section -->
<div th:replace="front-end/header_moblie.html"></div>
<!-- Start Side Vav -->
<div th:replace="/front-end/cart/cartview.html"></div>
<!-- End Side Vav -->
<a class="close_side_menu" href="javascript:void(0);"></a>

<div class="rbt-page-banner-wrapper">
    <!-- Start Banner BG Image  -->
    <div class="rbt-banner-image"></div>
    <!-- End Banner BG Image  -->
</div>

<!-- Start Card Style -->
<div class="rbt-dashboard-area rbt-section-overlayping-top rbt-section-gapBottom">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <!-- Start Dashboard Top  -->
                <div class="rbt-dashboard-content-wrapper">
                    <!--封面圖片-->
                    <div class="tutor-bg-photo bg_image bg_image--23 height-350"></div>
                    <!-- Start Tutor Information  -->
                    <div class="rbt-tutor-information">
                        <div class="rbt-tutor-information-left">
                            <div class="thumbnail rbt-avatars size-lg">
                                <img class="userHeadshot" id="headshot"
                                     th:data-user-id="${session.uId}" alt="User Headshot">
                            </div>
                            <div class="tutor-content">
                                <h5 class="title" th:text="${uNickname}">Emily Hannah</h5>
                                <ul class="rbt-meta rbt-meta-white mt--5">
                                    <li><i class="feather-book"></i>
                                        <span>已購買課程數量 :</span>
                                        <span th:text="${count}">5 Courses Enroled</span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="rbt-tutor-information-right">
                            <div class="tutor-btn">
                                <a class="rbt-btn btn-md hover-icon-reverse" href="/course/coach_dashboard">
                                        <span class="icon-reverse-wrapper">
                                           <span class="btn-text">教練模式</span>
                                           <span class="btn-icon"><i class="feather-arrow-right"></i></span>
                                           <span class="btn-icon"><i class="feather-arrow-right"></i></span>
                                        </span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- End Tutor Information  -->
                </div>
                <!-- End Dashboard Top  -->

                <div class="row g-5">
                    <div class="col-lg-3">
                        <!-- Start Dashboard Sidebar  -->
                        <div th:replace="front-end/member_sidebar"></div>
                        <!-- End Dashboard Sidebar  -->
                    </div>

                    <div class="col-lg-9">
                        <!-- Start Enrole Course  -->
                        <div class="rbt-dashboard-content bg-color-white rbt-shadow-box">
                            <div class="content">

                                <div class="section-title">
                                    <h4 class="rbt-title-style-3">我的課程</h4>
                                </div>

                                <div class="advance-tab-button mb--30">
                                    <ul class="nav nav-tabs tab-button-style-2 justify-content-start" id="myTab-4"
                                        role="tablist">
                                        <li role="presentation">
                                            <a href="#" class="tab-button active" id="home-tab-4" data-bs-toggle="tab"
                                               data-bs-target="#home-4" role="tab" aria-controls="home-4"
                                               aria-selected="true">
                                                <span class="title">我的課程</span>
                                            </a>
                                        </li>
                                        <li role="presentation">
                                            <a href="#" class="tab-button cr-history" id="profile-tab-4"
                                               data-bs-toggle="tab" data-bs-target="#profile-4" role="tab"
                                               aria-controls="profile-4" aria-selected="false">
                                                <span class="title">歷史瀏覽</span>
                                            </a>
                                        </li>

                                    </ul>
                                </div>

                                <div class="tab-content">
                                    <div class="tab-pane fade active show" id="home-4" role="tabpanel"
                                         aria-labelledby="home-tab-4">
                                        <div class="row g-5">
                                            <!--我的課程-->
                                            <!-- Start Single Card-->
                                            <th:block th:each="myCourses : ${myCourse}">
                                                <div class="col-lg-4 col-md-6 col-sm-6 col-12">
                                                    <div class="rbt-card variation-01 rbt-hover">
                                                        <div class="rbt-card-img">
                                                            <a th:href="@{'/course/single_course/' + ${myCourses.crId}}">
                                                                <img class="courseCover" id="crcover"
                                                                     th:data-course-id="${myCourses.crId}"
                                                                     alt="Card image">
                                                            </a>
                                                        </div>
                                                        <div class="rbt-card-body">
                                                            <div class="rbt-card-top">
                                                                <!--                                                                評價星星-->
                                                                <!--                                                                <div class="rbt-review">-->
                                                                <!--                                                                    <div class="rating">-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                    </div>-->
                                                                <!--                                                                    <span class="rating-count"> (5 Reviews)</span>-->
                                                                <!--                                                                </div>-->
                                                                <!--                                                                <div class="rbt-bookmark-btn">-->
                                                                <!--                                                                    <a class="rbt-round-btn" title="Bookmark" th:href="@{#}"><i-->
                                                                <!--                                                                            class="feather-bookmark"></i></a>-->
                                                                <!--                                                                </div>-->
                                                            </div>
                                                            <h4 class="rbt-card-title"><a href="course-details.html"
                                                                                          th:text="${myCourses.crTitle}"></a>
                                                            </h4>
                                                            <!--                                                            <ul class="rbt-meta">-->
                                                            <!--                                                                <li><i class="feather-book"></i>8 Lessons</li>-->
                                                            <!--                                                                <li><i class="feather-users"></i>30 Students</li>-->
                                                            <!--                                                            </ul>-->
                                                            <p class="rbt-card-text"
                                                               th:text="${myCourses.crSubtitle}"></p>

                                                            <div class="rbt-author-meta mb--20">
                                                                <div class="rbt-avater" id="uId"
                                                                     th:data-session-uid="${myCourses.getUserVO().getuId()}">
                                                                    <a th:href="@{'/single_course/' + ${myCourses.getUserVO().getuId()}}">
                                                                        <img class="userHeadshot"
                                                                             th:data-user-id="${myCourses.getUserVO().getuId()}"
                                                                             alt="User Headshot2">
                                                                    </a>
                                                                </div>
                                                                <div class="rbt-author-info">
                                                                    By <span
                                                                        th:text="${myCourses.getUserVO().getuNickname()}"></span>
                                                                </div>
                                                            </div>
                                                            <!--   進度條-->
                                                            <!--                                                            <div class="rbt-progress-style-1 mb&#45;&#45;20 mt&#45;&#45;10">-->
                                                            <!--                                                                <div class="single-progress">-->
                                                            <!--                                                                    <h6 class="rbt-title-style-2 mb&#45;&#45;10">觀看進度</h6>-->
                                                            <!--                                                                    <div class="progress">-->
                                                            <!--                                                                        <div class="progress-bar wow fadeInLeft bar-color-success" data-wow-duration="0.5s" data-wow-delay=".3s" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">-->
                                                            <!--                                                                        </div>-->
                                                            <!--                                                                        <span class="rbt-title-style-2 progress-number">65%</span>-->
                                                            <!--                                                                    </div>-->
                                                            <!--                                                                </div>-->
                                                            <!--                                                            </div>-->

                                                            <div class="rbt-card-bottom">
                                                                <a class="rbt-btn btn-sm bg-primary-opacity w-100 text-center"
                                                                   th:href="@{'/course/single_course/' + ${myCourses.crId}}">查看課程</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </th:block>
                                            <!-- End Single Card  -->

                                        </div>
                                    </div>


                                    <!-- 歷史瀏覽 -->
                                    <div class="tab-pane fade" id="cr-history" role="tabpanel"
                                         aria-labelledby="profile-tab-4">
                                        <div class="row g-5">

                                            <!--Start Single Card-->
                                            <th:block class="cr-history" th:each="history : ${courseHistory}">
                                                <div class="col-lg-4 col-md-6 col-sm-6 col-12">
                                                    <div class="rbt-card variation-01 rbt-hover">
                                                        <div class="rbt-card-img">
                                                            <a th:href="@{'/course/single_course/' + ${history.crId}}">
                                                                <img class="courseCover" id="c_cover"
                                                                     th:data-course-id="${history.crId}"
                                                                     alt="Card image">
                                                            </a>
                                                        </div>
                                                        <div class="rbt-card-body">
                                                            <div class="rbt-card-top">
                                                                <!--                                                                <div class="rbt-review">-->
                                                                <!--                                                                    <div class="rating">-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                        <i class="fas fa-star"></i>-->
                                                                <!--                                                                    </div>-->
                                                                <!--                                                                    <span class="rating-count"> (5 Reviews)</span>-->
                                                                <!--                                                                </div>-->
                                                                <!--                                                                <div class="rbt-bookmark-btn">-->
                                                                <!--                                                                    <a class="rbt-round-btn" title="Bookmark"-->
                                                                <!--                                                                       th:href="@{#}"><i-->
                                                                <!--                                                                            class="feather-bookmark"></i></a>-->
                                                                <!--                                                                </div>-->
                                                            </div>
                                                            <h4 class="rbt-card-title"><a href="course-details.html"
                                                                                          th:text="${history.crTitle}"></a>
                                                            </h4>
                                                            <!--                                                            <ul class="rbt-meta">-->
                                                            <!--                                                                <li><i class="feather-book"></i>8 Lessons</li>-->
                                                            <!--                                                                <li><i class="feather-users"></i>30 Students</li>-->
                                                            <!--                                                            </ul>-->
                                                            <p class="rbt-card-text"
                                                               th:text="${history.crSubtitle}"></p>

                                                            <div class="rbt-author-meta mb--20">
                                                                <div class="rbt-avater">
                                                                    <a th:href="@{'/single_course/' + ${history.crId}}">
                                                                        <img class="userHeadshot"
                                                                             th:data-user-id="${uId}"
                                                                             alt="User Headshot2">
                                                                    </a>
                                                                </div>
                                                                <div class="rbt-author-info">
                                                                    By <span
                                                                        th:text="${uNickname}"></span>
                                                                </div>
                                                            </div>
                                                            <div class="rbt-card-bottom">
                                                                <div class="rbt-price">
                                                                <span class="current-price"
                                                                      th:text="'NT$'+ ${history.crPrice}"></span>
                                                                </div>
                                                                <a class="rbt-btn-link left-icon"
                                                                   href="javascript:void(0);"
                                                                   th:onclick="'add2Cart(' + ${history.crId} + ');'">
                                                                    <i class="feather-shopping-cart"></i>加入購物車
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </th:block>
                                            <!--                                             End Single Card-->

                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <!-- End Enrole Course  -->
            </div>

        </div>

    </div>
</div>
</div>
</div>
<!-- End Card Style -->


<div class="rbt-separator-mid">
    <div class="container">
        <hr class="rbt-separator m-0">
    </div>
</div>
<!-- Start Footer aera -->
<div th:replace="front-end/footer"></div>
<!-- End Footer aera -->
<div class="rbt-progress-parent">
    <svg class="rbt-back-circle svg-inner" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
    </svg>
</div>

<!-- JS
============================================ -->
<!-- Modernizer JS -->
<script th:src="@{/assets/js/vendor/modernizr.min.js}"></script>
<!-- jQuery JS -->
<script th:src="@{/assets/js/vendor/jquery.js}"></script>
<!-- Bootstrap JS -->
<script th:src="@{/assets/js/vendor/bootstrap.min.js}"></script>
<!-- sal.js -->
<script th:src="@{/assets/js/vendor/sal.js}"></script>
<script th:src="@{/assets/js/vendor/swiper.js}"></script>
<script th:src="@{/assets/js/vendor/magnify.min.js}"></script>
<script th:src="@{/assets/js/vendor/jquery-appear.js}"></script>
<script th:src="@{/assets/js/vendor/odometer.js}"></script>
<script th:src="@{/assets/js/vendor/backtotop.js}"></script>
<script th:src="@{/assets/js/vendor/isotop.js}"></script>
<script th:src="@{/assets/js/vendor/imageloaded.js}"></script>

<script th:src="@{/assets/js/vendor/wow.js}"></script>
<script th:src="@{/assets/js/vendor/waypoint.min.js}"></script>
<script th:src="@{/assets/js/vendor/easypie.js}"></script>
<script th:src="@{/assets/js/vendor/text-type.js}"></script>
<script th:src="@{/assets/js/vendor/jquery-one-page-nav.js}"></script>
<script th:src="@{/assets/js/vendor/bootstrap-select.min.js}"></script>
<script th:src="@{/assets/js/vendor/jquery-ui.js}"></script>
<script th:src="@{/assets/js/vendor/magnify-popup.min.js}"></script>
<script th:src="@{/assets/js/vendor/paralax-scroll.js}"></script>
<script th:src="@{/assets/js/vendor/paralax.min.js}"></script>
<script th:src="@{/assets/js/vendor/countdown.js}"></script>
<script th:src="@{/assets/js/vendor/plyr.js}"></script>
<!-- Main JS -->
<script th:src="@{/assets/js/main.js}"></script>

<script>

    //userRestController getUserHeadshot
    $(document).ready(function () {
        let userIdList = [];

        $('.userHeadshot').each(function () {
            let data = $(this).data('user-id');

            // fetch 可以直接處理二進制資料(如blob)
            fetch('/user_api/user_headshot_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({u_id: data}),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('response error');
                    }
                    return response.blob();
                })
                .then(blob => {
                    let image_Url = URL.createObjectURL(blob);

                    let this_e = $(this);
                    $(this).attr('src', image_Url);
                })
                .catch(error => {
                    console.error('找不到user image:', error);
                    $(this).attr('src', '/assets/images/client/avatar-02.png');
                });
        });
    });

    // StudentCourseRestController getcrCover
    $(document).ready(function () {
        let courseIdList = [];
        $('.courseCover').each(function () {
            let data = $(this).data('course-id');

            fetch('/cr_cover/course_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({cr_id: data}),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('response error');
                    }
                    return response.blob();
                })
                .then(blob => {
                    let image_cover = URL.createObjectURL(blob);
                    $(this).attr('src', image_cover);
                })
                .catch(error => {
                    console.error('找不到user image:', error);
                    $(this).attr('src', '/assets/images/client/avatar-02.png');
                });
        });
    });

    $(document).on('click', '.cr-history', function () {
        $('#home-4').removeClass('show').hide();

        $('#cr-history').addClass('show').show();
        let uId = $('#uId').data('session-uid');
        // console.log('登入用戶Id: ' + uId);
        getCourseHistory(uId);

        function getCourseHistory(uId) {

            fetch(`/api/history/get/${uId}`)
                .then(response => response.json())
                .then(data => {
                    // 把取到的歷史紀錄抓起來
                    console.log(data);
                })
                .catch(error => console.error('Error:', error));
        }
    });
    $(document).on('click', '#home-tab-4', function () {
        $('#cr-history').removeClass('show').hide();
        $('#home-4').addClass('show').show();
    })

    // cart
    const add2Cart = (crId) => {

        fetch('/cart/add', {
            method: 'POST',
            body: crId,
            headers: {
                "content-type": "application/json",
            }
        }).then((res) => {
            if (res.redirected){
                window.location.href = res.url;
            }
            if (res.status === 401) {
                // 未登入回到登入頁面
                alert('請先登入！')
                window.location.href = '/user/force_user_login';
            } else {
                return res.text();
            }
        }).then((data) => {
            if (data === '您已擁有該課程！') {
                alert(data);
            } else if (data === '成功添加至購物車！')
                console.log(data);
        }).catch((error) => {
            console.error("發生錯誤:" + error);
        });
    }


</script>

</body>

</html>